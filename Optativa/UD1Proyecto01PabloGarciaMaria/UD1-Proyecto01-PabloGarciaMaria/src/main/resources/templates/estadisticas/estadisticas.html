<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas - SubManager</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
          rel="stylesheet" />

    <!-- CSS personalizado -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/estadisticas.css">
</head>

<body>
<th:block th:replace="~{fragments/navbar.html :: navbar}"></th:block>
<div class="container">
    <div class="stats-container">
        <div class="stats-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="stats-title">
                        <i class="fas fa-chart-bar me-2"></i>Estadísticas Detalladas
                    </h1>
                    <p class="text-muted mb-0">Análisis completo de tus suscripciones y gastos</p>
                </div>
                <div class="col-md-4 text-end">
                        <span class="badge bg-primary fs-6">
                            Período: <span th:text="${periodoActual}">Últimos 30 días</span>
                        </span>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Período de Tiempo</label>
                    <select class="form-select select2-enhanced" id="periodoSelect">
                        <option value="30" selected>Últimos 30 días</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="180">Últimos 6 meses</option>
                        <option value="365">Último año</option>
                        <option value="999">Todo el historial</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Categoría</label>
                    <select class="form-select select2-enhanced" id="categoriaSelect">
                        <option value="all" selected>Todas las categorías</option>
                        <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat}"></option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Plataforma</label>
                    <select class="form-select select2-enhanced" id="plataformaSelect">
                        <option value="all" selected>Todas las plataformas</option>
                        <option th:each="plat : ${plataformas}" th:value="${plat.id}" th:text="${plat.nombre}">
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Métricas Principales -->
        <div class="metric-grid">
            <div class="stat-card">
                <div class="stat-number" th:text="'€' + ${#numbers.formatDecimal(gastoTotal, 1, 2)}">€0.00</div>
                <!-- Expliacion rapida para no volverme loco.
                    Gasto total de ESTADISTICAS (GTE).
                    Gasto mensual de DASHBOARD (GMD).
                    EVOLUCION DE GASTOS MENSUALES  (EGM)

                    NO SON LO MISMO, GTE se basa en un periodo, es decir, los ultimos 30 dias.
                    GMD y EGM si que son lo mismo por que ambos se basan en el mes para buscar suscripciones.
                -->
                <div class="stat-label">Gasto Total</div>
                <div class="trend-indicator">
                        <span th:classappend="${variacionGastoTotal >= 0} ? 'change-positive' : 'change-negative'"
                              class="stat-change">
                            <i
                                    th:classappend="${variacionGastoTotal >= 0} ? 'fas fa-arrow-up' : 'fas fa-arrow-down'"></i>
                            <span th:text="${#numbers.formatDecimal(variacionGastoTotal, 1, 1)} + '%'">0%</span>
                        </span>
                    <span class="text-muted ms-2">vs período anterior <p>(<span
                            th:text="${#numbers.formatDecimal(gastoTotalAnterior,1,2)}"></span>)</p></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-number" th:text="${totalSuscripciones}">0</div>
                <div class="stat-label">Suscripciones Activas</div>
                <div class="trend-indicator">
                        <span th:classappend="${variacionSuscripciones >= 0} ? 'change-positive' : 'change-negative'"
                              class="stat-change">
                            <i
                                    th:classappend="${variacionSuscripciones >= 0} ? 'fas fa-arrow-up' : 'fas fa-arrow-down'"></i>
                            <span th:text="${variacionSuscripciones} + ''">0</span>
                        </span>
                    <span class="text-muted ms-2">vs período anterior<p>(<span
                            th:text="${totalSuscripcionesAnterior}"></span>)</p></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-number" th:text="'€' + ${#numbers.formatDecimal(gastoPromedio, 1, 2)}">€0.00</div>
                <div class="stat-label">Gasto Promedio Mensual</div>
                <div class="trend-indicator">
                        <span th:classappend="${variacionGastoPromedio >= 0} ? 'change-positive' : 'change-negative'"
                              class="stat-change">
                            <i
                                    th:classappend="${variacionGastoPromedio >= 0} ? 'fas fa-arrow-up' : 'fas fa-arrow-down'"></i>
                            <span th:text="${#numbers.formatDecimal(variacionGastoPromedio, 1, 1)} + '%'">0%</span>
                        </span>
                    <span class="text-muted ms-2">vs período anterior <p>(<span
                            th:text="${#numbers.formatDecimal(gastoPromedioAnterior,1,2)}"></span>)</p></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-number" th:text="${totalPlataformas}">0</div>
                <div class="stat-label">Plataformas Diferentes</div>
                <div class="trend-indicator">
                        <span class="stat-change change-positive">
                            <i class="fas fa-plus"></i>
                            <span th:text="${nuevasPlataformas}">0</span>
                        </span>
                    <span class="text-muted ms-2">vs período anterior <p>(<span
                            th:text="${totalPlataformasAnterior}"></span>)</p></span>
                </div>
            </div>
        </div>

        <!-- Primera Fila: Gráficos Principales -->
        <div class="row">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-line me-2"></i>Evolución de Gastos Mensuales
                    </h5>
                    <div style="width: 80%; max-width: 800px; margin: auto; height: 350px;">
                        <canvas id="gastosMensualesChart" height="350"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-pie me-2"></i>Distribución por Categoría
                    </h5>
                    <canvas id="distribucionCategoriaChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Segunda Fila: Más Gráficos y Estadísticas -->
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-tv me-2"></i>Gasto por Plataforma
                    </h5>
                    <div style="width: 80%; max-width: 800px; margin: auto; height: 350px;">
                        <canvas id="gastoPlataformaChart" height="350"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-calendar-alt me-2"></i>Porcentaje de Renovacion
                    </h5>
                    <div style="width: 80%; max-width: 800px; margin: auto; height: 350px;">
                        <canvas id="renovacionesChart" height="350"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tercera Fila: Insights y Comparativas -->
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-lightbulb me-2"></i>Insights y Recomendaciones
                    </h5>
                    <div class="insight-card">
                        <div class="insight-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="insight-text" th:text="${insightTendencia}">
                            Tu gasto ha aumentado un 15% respecto al período anterior.
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="insight-text" th:text="${insightAlertas}">
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-balance-scale me-2"></i>Comparativa con Período Anterior
                    </h5>
                    <table class="comparison-table">
                        <thead>
                        <tr>
                            <th>Métrica</th>
                            <th>Actual</th>
                            <th>Anterior</th>
                            <th>Variación</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>Gasto Total</td>
                            <td th:text="'€' + ${#numbers.formatDecimal(gastoTotal, 1, 2)}">€0.00</td>
                            <td th:text="'€' + ${#numbers.formatDecimal(gastoTotalAnterior, 1, 2)}">€0.00</td>
                            <td>
                                        <span
                                                th:classappend="${variacionGastoTotal >= 0} ? 'change-positive' : 'change-negative'"
                                                class="stat-change">
                                            <span
                                                    th:text="${#numbers.formatDecimal(variacionGastoTotal, 1, 1)} + '%'">0%</span>
                                        </span>
                            </td>
                        </tr>
                        <tr>
                            <td>Suscripciones Activas</td>
                            <td th:text="${totalSuscripciones}">0</td>
                            <td th:text="${totalSuscripcionesAnterior}">0</td>
                            <td>
                                        <span
                                                th:classappend="${variacionSuscripciones >= 0} ? 'change-positive' : 'change-negative'"
                                                class="stat-change">
                                            <span th:text="${variacionSuscripciones}">0</span>
                                        </span>
                            </td>
                        </tr>
                        <tr>
                            <td>Gasto Promedio</td>
                            <td th:text="'€' + ${#numbers.formatDecimal(gastoPromedio, 1, 2)}">€0.00</td>
                            <td th:text="'€' + ${#numbers.formatDecimal(gastoPromedioAnterior, 1, 2)}">€0.00
                            </td>
                            <td>
                                        <span
                                                th:classappend="${variacionGastoPromedio >= 0} ? 'change-positive' : 'change-negative'"
                                                class="stat-change">
                                            <span
                                                    th:text="${#numbers.formatDecimal(variacionGastoPromedio, 1, 1)} + '%'">0%</span>
                                        </span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cuarta Fila: Estadísticas Detalladas -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-list-alt me-2"></i>Estadísticas Detalladas por Plataforma
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Plataforma</th>
                                <th>Gasto Total</th>
                                <th>% del Total</th>
                                <th>Suscripciones</th>
                                <th>Gasto Promedio</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="estadistica : ${estadisticasPlataformas}">
                                <td>
                                            <span class="platform-badge"
                                                  th:style="'background-color: ' + ${estadistica.color} + '; color: white;'"
                                                  th:text="${estadistica.nombre}">
                                                Plataforma
                                            </span>
                                </td>
                                <td th:text="'€' + ${#numbers.formatDecimal(estadistica.gastoTotal, 1, 2)}">
                                    €0.00</td>
                                <td
                                        th:text="${#numbers.formatDecimal(estadistica.porcentajeTotal, 1, 1)} + '%'">
                                    0%</td>
                                <td th:text="${estadistica.totalSuscripciones}">0</td>
                                <td th:text="'€' + ${#numbers.formatDecimal(estadistica.gastoPromedio, 1, 2)}">
                                    €0.00</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quinta Fila: Métricas Adicionales -->
        <div class="row">
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="stat-number" th:text="${suscripcionesConAutoRenovacion} + '/' + ${totalPlataformas}">0/0</div>
                    <div class="stat-label">Auto-Renovación Activada</div>
                    <div class="text-muted small">
                        <span th:text="${#numbers.formatDecimal((suscripcionesConAutoRenovacion / totalPlataformas) * 100, 1, 0)}">0</span>% de tus suscripciones
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="stat-number" th:text="${categoriaMasCara}">N/A</div>
                    <div class="stat-label">Categoría Más Costosa</div>
                    <div class="text-muted small" th:text="'€' + ${#numbers.formatDecimal(gastoCategoriaMasCara, 1, 2)} + ' mensuales'">
                        €0.00 mensuales
                    </div>
                </div>
            </div>
        </div>
    </div>

    <span hidden id="data-container" th:data-mesesLabels="${mesesLabels}"
          th:data-gastosMensualesData="${gastosMensualesData}" th:data-categoriasLabels="${categoriasLabels}"
          th:data-categoriasData="${categoriasData}" th:data-categoriasColores="${categoriasColores}"
          th:data-plataformasLabels="${plataformasLabels}" th:data-plataformasData="${plataformasData}"
          th:data-renovacionesLabels="${renovacionesLabels}" th:data-renovacionesData="${renovacionesData}"></span>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery (requerido por Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- JavaScript personalizado -->
<script src="/js/estadisticas/estadisticas.js"></script>
</body>

</html>